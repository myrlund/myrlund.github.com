<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Jonas Myrlund</title>
    
    <link rel="stylesheet/less" href="/stylesheets/less/styles.less">
    <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.3.0/less-1.3.0.min.js"></script>
    
    <!-- <link rel="stylesheet" href="stylesheets/styles.min.css"> -->
    
    <link rel="stylesheet" href="stylesheets/pygments.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/bootstrap-collapse.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body class="home">
    
    <header class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <nav class="container">
          <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          
          <h1 class="brand">
            <a href="/">Jonas Myrlund</a>
            <small>and his mindless mind dumps</small>
          </h1>
          
          <div class="nav-collapse">
            <ul class="nav pull-right">
              <li><a href="http://twitter.com/myrlund" class="">Follow me on Twitter</a></li>
              <li><a href="https://github.com/myrlund" class="">My projects on GitHub &rarr;</a></li>
            </ul>
          </div>
        </nav>
      </div>
    </header><!-- end header -->

    <div class="container">
      
      <section id="mainarea" class="row">

        <ol class="posts span8">
  
    <li>
      

<article class="post">
  <header class="post-title">
  <h1>
    <a href="/2012/07/28/64-bit-ints-in-javascript/">64-bit integers in Javascript</a>
  </h1>
</header>


  <div class="content">
    <p>A couple of weeks ago, upon implementing a web socket protocol using JSON-encoded messages, we ran into quite the problem.</p><p>Server side, various ids and generation numbers were stored as 64-bit integers. But alas, as it turns out, Javascript doesn&#8217;t support 64-bit integers&#8230; At all. It doesn&#8217;t even whine. Any number exceeding 9007199254740992 will silently be padded with zeros&#8230; No wonder we didn&#8217;t get the expected results in our interactions with the server.</p><p><em>In case you&#8217;re one of those people: Javascript&#8217;s numbers are represented using 64-bit floating points with double precision, and hence the integers can&#8217;t exceed 2<sup>53</sup>. Consult the <a href='http://ecma262-5.com/ELS5_HTML.htm#Section_8.5'>ECMAscript language specification</a> for more information.</em></p><p>Anyways, back to the story. With the protocol well in production on other platforms, it wasn&#8217;t likely to change, so <em>a hairy fix was needed</em>.</p><p>Luckily, the encoded JSON strings arrive over web sockets as just that: strings. Problem is, the moment one tries to <code>JSON.parse(jsonString)</code> it&#8217;s already too late &#8211; information is lost.</p><h3 id='regex_to_the_rescue'>Regex to the rescue</h3><p>Our <del>temporary</del> solution consisted of three parts:</p><ol>
<li>running a simple regex over the incoming strings before parsing them</li>

<li>running a similar regex over the outgoing strings after serializing them</li>

<li>using string representations of the int64 fields internally</li>
</ol><p>The incoming messages we handled like so:</p><div class='highlight'><pre><code class='javascript'><span class='kd'>var</span> <span class='nx'>numbers</span> <span class='o'>=</span> <span class='sr'>/(&quot;[^&quot;]*&quot;:\s*)(\d{15,})(\[,}])/g</span>
<span class='nx'>jsonString</span> <span class='o'>=</span> <span class='nx'>jsonString</span><span class='p'>.</span><span class='nx'>replace</span><span class='p'>(</span><span class='nx'>numbers</span><span class='p'>,</span> <span class='s2'>&quot;$1\&quot;$2\&quot;$3&quot;</span><span class='p'>)</span>
</code></pre>
</div><p>&#8230;and the outgoing messages we handled like so:</p><div class='highlight'><pre><code class='javascript'><span class='kd'>var</span> <span class='nx'>stringifiedNumbers</span> <span class='o'>=</span> <span class='sr'>/(&quot;[^&quot;]*&quot;:\s*)&quot;(\d{15,})&quot;(\[,}])/g</span>
<span class='nx'>jsonString</span> <span class='o'>=</span> <span class='nx'>jsonString</span><span class='p'>.</span><span class='nx'>replace</span><span class='p'>(</span><span class='nx'>stringifiedNumbers</span><span class='p'>,</span> <span class='s2'>&quot;$1$2$3&quot;</span><span class='p'>)</span>
</code></pre>
</div><h3 id='the_moral_of_the_story'>The moral of the story&#8230;</h3><ol>
<li>Unless absolutely necessary, avoid using numeric ids if they can be expected to become very large.</li>

<li>Regexes are awesome, although completely unreadable.</li>
</ol>
  </div>
  
  <p class="byline muted well">
    <span><i class="icon-white icon-time"></i> 2012-07-28</span>
    <span><i class="icon-white icon-bookmark"></i> Javascript</span>
    <!-- <span><i class="icon-white icon-comment"></i> <a href="/2012/07/28/64-bit-ints-in-javascript/">Comments</a></span> -->
  </p>
</article>

    </li>
  
    <li>
      

<article class="post">
  <header class="post-title">
  <h1>
    <a href="/2012/07/24/yay-i-have-a-developer-blog/">Yay! I have a developer blog.</a>
  </h1>
</header>


  <div class="content">
    <p>So, it has come to this. I&#8217;ve set up a blog &#8211; and a real one at that; not some Wordpress crap, but <a href='http://comoyo.github.com/blog/2012/06/11/how-comoyo-built-its-blog/'>authentic Jekyll-from-scratch, Git-powered awesomeness</a>.</p><p>I&#8217;ve tried to keep blogs running before, but &#8211; as with most people &#8211; i ran out of topics to write about. Now, whether I actually ran out of topics to write about or I simply ran out of <em>knowledge</em>, I don&#8217;t really know.</p><p>I think the problem might have been that I didn&#8217;t dig deep enough to well up something of interest to other people, but that&#8217;s (hopefully) slowly changing. Even though I&#8217;m nowhere near a virtuoso in any of my day-to-day work, I think I might have something to contribute to the interwebs this time around. At least more than before.</p><p>The first posts will most likely revolve around the concoction of technologies I&#8217;ve been spending time with this summer, namely backend-less <a href='http://backbonejs.org/'>Backbone</a>-driven Javascript, fancy-pantsy HTML5 stuff like <a href='http://www.html5rocks.com/en/tutorials/websockets/basics/'>WebSockets</a> and <a href='http://coding.smashingmagazine.com/2010/10/11/local-storage-and-how-to-use-it/'>localStorage</a>, <a href='http://www.alistapart.com/articles/responsive-web-design/'>responsive designs</a>, and perhaps mostly: <em>what happens if you try to smash them all together</em>. There&#8217;s also a sizable chance I&#8217;ll soon be spewing out some ramblings on some unusual Ruby on Rails stuff, like running multiple apps on a shared core backend using <a href='http://guides.rubyonrails.org/engines.html'>the new Rails Engines introduced in Rails 3.1</a>.</p><p>Anyways&#8230; So, should you come back later for some actual content? Yes, please do.</p><p><em>Stay classy, internet.</em></p>
  </div>
  
  <p class="byline muted well">
    <span><i class="icon-white icon-time"></i> 2012-07-24</span>
    <span><i class="icon-white icon-bookmark"></i> Meta</span>
    <!-- <span><i class="icon-white icon-comment"></i> <a href="/2012/07/24/yay-i-have-a-developer-blog/">Comments</a></span> -->
  </p>
</article>

    </li>
  
</ol>

        
        <aside class="author span4">
          
          <div class="well">
  <img src="http://www.gravatar.com/avatar/32738b0ba76006f2f57c3dac162fe87a.png" alt="Jonas Myrlund" class="pull-right image">
  <h3>Jonas Myrlund</h3>
  <dl class="dl">
    <dt>Website</dt><dd><a href="http://myrlund.github.com">http://myrlund.github.com</a></dd>
    <dt>Twitter</dt><dd><a href="http://twitter.com/myrlund">@myrlund</a></dd>
    
  </dl>
  <p>I&#8217;m an averagely nice guy studying comp.sci. at NTNU. I like to play guitar, drink real beer and boss people around.</p>

<p>I spend my days <span title='selling >100k liters of beer per year'>running catering operations</span> at <a href='http://samfundet.no'>Samfundet</a>, working as a software developer intern at <a href='http://comoyo.com'>Comoyo</a>, and filling in my spare time with <a href='http://github.com/myrlund'>various side projects</a>.</p>

<p>Sometimes I even study!!!</p>
</div>
        </aside>
        
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
    
  </body>
</html>